name: Release

on:
    push:
        tags:
            - "v*" # Triggers on tags like v1.0.0, v1.2.3

permissions:
    contents: write # Needed to create releases

jobs:
    release:
        name: Create Release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for changelog

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: Run tests
              run: go test ./...

            - name: Build binaries
              run: |
                  # Calculate the date
                  RELEASE_DATE=$(date +'%d - %B - %Y')

                  # Get the short commit hash
                  COMMIT_HASH=$(git rev-parse --short HEAD)

                  # Create the linker flags for all three variables
                  LDFLAGS="-X main.Version=${{ github.ref_name }} \
                           -X 'main.BuildDate=$RELEASE_DATE' \
                           -X main.Commit=$COMMIT_HASH"

                  # Windows
                  GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o officeforge-windows-amd64.exe ./cmd/officeforge
                  GOOS=windows GOARCH=arm64 go build -ldflags "$LDFLAGS" -o officeforge-windows-arm64.exe ./cmd/officeforge

                  # Linux
                  GOOS=linux GOARCH=amd64 go build -ldflags "$LDFLAGS" -o officeforge-linux-amd64 ./cmd/officeforge
                  GOOS=linux GOARCH=arm64 go build -ldflags "$LDFLAGS" -o officeforge-linux-arm64 ./cmd/officeforge

                  # macOS (Darwin)
                  GOOS=darwin GOARCH=amd64 go build -ldflags "$LDFLAGS" -o officeforge-darwin-amd64 ./cmd/officeforge
                  GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o officeforge-darwin-arm64 ./cmd/officeforge

            - name: Generate checksums
              run: |
                  sha256sum officeforge-* > checksums.txt

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      officeforge-windows-amd64.exe
                      officeforge-windows-arm64.exe
                      officeforge-linux-amd64
                      officeforge-linux-arm64
                      officeforge-darwin-amd64
                      officeforge-darwin-arm64
                      checksums.txt
                  body: |
                      ## Installation

                      Download the appropriate binary for your system and architecture.

                      ### MacOS / Linux
                      After downloading, give the binary execution permissions:
                      ```bash
                      chmod +x officeforge-linux-amd64
                      ./officeforge-linux-amd64 version
                      ```
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
